<!DOCTYPE html><html lang="en"><head><title>libs/repoManager</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="libs/repoManager"><meta name="groc-project-path" content="libs/repoManager.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">libs/repoManager.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Define some pseudo module globals</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> isPro = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isPro;
<span class="hljs-keyword">var</span> isDev = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isDev;
<span class="hljs-keyword">var</span> isDbg = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isDbg;

<span class="hljs-keyword">var</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>);
<span class="hljs-keyword">var</span> async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);

<span class="hljs-keyword">var</span> Strategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/strategy'</span>).Strategy;

<span class="hljs-keyword">var</span> nil = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers'</span>).nil;
<span class="hljs-keyword">var</span> github = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/githubClient'</span>);

<span class="hljs-keyword">var</span> clientId = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">var</span> clientKey = <span class="hljs-literal">null</span>;

Strategy.findOne({ name: <span class="hljs-string">'github'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aStrat)</span> </span>{
  clientId = aStrat.id;
  clientKey = aStrat.key;
});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Requests a GitHub url and returns the chunks as buffers</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchRaw</span><span class="hljs-params">(aHost, aPath, aCallback)</span> </span>{
  <span class="hljs-keyword">var</span> options = {
    hostname: aHost,
    port: <span class="hljs-number">443</span>,
    path: aPath,
    method: <span class="hljs-string">'GET'</span>,
    headers: { <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Node.js'</span> }
  };

  <span class="hljs-keyword">var</span> req = https.request(options,
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aRes)</span> </span>{
      <span class="hljs-keyword">var</span> bufs = [];
      <span class="hljs-keyword">if</span> (aRes.statusCode !== <span class="hljs-number">200</span>) { <span class="hljs-built_in">console</span>.log(aRes.statusCode); <span class="hljs-keyword">return</span> aCallback([<span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">''</span>)]); }
      <span class="hljs-keyword">else</span> {
        aRes.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aData)</span> </span>{ bufs.push(aData); });
        aRes.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          aCallback(bufs);
        });
      }
    });
  req.end();
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use for call the GitHub JSON api
Returns the JSON parsed object</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchJSON</span><span class="hljs-params">(aPath, aCallback)</span> </span>{
  aPath += <span class="hljs-string">'?client_id='</span> + clientId + <span class="hljs-string">'&amp;client_secret='</span> + clientKey;
  fetchRaw(<span class="hljs-string">'api.github.com'</span>, aPath, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aBufs)</span> </span>{
    aCallback(<span class="hljs-built_in">JSON</span>.parse(Buffer.concat(aBufs).toString()));
  });
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This manages actions on the repos of a user</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RepoManager</span><span class="hljs-params">(aUserId, aUser, aRepos)</span> </span>{
  <span class="hljs-keyword">this</span>.userId = aUserId;
  <span class="hljs-keyword">this</span>.user = aUser;
  <span class="hljs-keyword">this</span>.repos = aRepos || nil();
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Fetches the information about repos that contain user scripts</p></div></div><div class="code"><div class="wrapper">RepoManager.prototype.fetchRecentRepos = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aCallback)</span> </span>{
  <span class="hljs-keyword">var</span> repoList = [];
  <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;

  async.waterfall([
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aCallback)</span> </span>{
      github.repos.getFromUser({
        user: <span class="hljs-built_in">encodeURIComponent</span>(that.userId),
        sort: <span class="hljs-string">'updated'</span>,
        order: <span class="hljs-string">'desc'</span>,
        per_page: <span class="hljs-number">3</span>,
      }, aCallback);
    },
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aGithubRepoList, aCallback)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Don&#39;t search through forks
to speedup this request.
aGithubRepoList = _.where(aGithubRepoList, {fork: false});</p></div></div><div class="code"><div class="wrapper">      _.map(aGithubRepoList, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aGithubRepo)</span> </span>{
        repoList.push(<span class="hljs-keyword">new</span> Repo(that, aGithubRepo.owner.login, aGithubRepo.name));
      });

      async.each(repoList, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aRepo, aCallback)</span> </span>{
        aRepo.fetchUserScripts(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          aCallback(<span class="hljs-literal">null</span>);
        });
      }, aCallback);
    },
  ], aCallback);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Import scripts on GitHub</p></div></div><div class="code"><div class="wrapper">RepoManager.prototype.loadScripts = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aCallback, aUpdate)</span> </span>{
  <span class="hljs-keyword">var</span> scriptStorage = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../controllers/scriptStorage'</span>);
  <span class="hljs-keyword">var</span> arrayOfRepos = <span class="hljs-keyword">this</span>.makeRepoArray();
  <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: remove usage of makeRepoArray since it causes redundant looping</p></div></div><div class="code"><div class="wrapper">  arrayOfRepos.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aRepo)</span> </span>{
    async.each(aRepo.scripts, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aScript, aCallback)</span> </span>{
      <span class="hljs-keyword">var</span> url = <span class="hljs-string">'/'</span> + <span class="hljs-built_in">encodeURI</span>(aRepo.user) + <span class="hljs-string">'/'</span> + <span class="hljs-built_in">encodeURI</span>(aRepo.repo)
        + <span class="hljs-string">'/master'</span> + aScript.path;
      fetchRaw(<span class="hljs-string">'raw.githubusercontent.com'</span>, url, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aBufs)</span> </span>{
        scriptStorage.getMeta(aBufs, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aMeta)</span> </span>{
          <span class="hljs-keyword">if</span> (aMeta) {
            scriptStorage.storeScript(that.user, aMeta, Buffer.concat(aBufs),
              aCallback, aUpdate);
          }
        });
      });
    }, aCallback);
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create the Mustache object to display repos with their user scrips</p></div></div><div class="code"><div class="wrapper">RepoManager.prototype.makeRepoArray = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> retOptions = [];
  <span class="hljs-keyword">var</span> repos = <span class="hljs-keyword">this</span>.repos;
  <span class="hljs-keyword">var</span> username = <span class="hljs-keyword">this</span>.user.ghUsername;
  <span class="hljs-keyword">var</span> reponame = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> scripts = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> scriptname = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> option = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">for</span> (reponame <span class="hljs-keyword">in</span> repos) {
    option = { repo: reponame, user: username };
    option.scripts = [];

    scripts = repos[reponame];
    <span class="hljs-keyword">for</span> (scriptname <span class="hljs-keyword">in</span> scripts) {
      option.scripts.push({ name: scriptname, path: scripts[scriptname] });
    }

    retOptions.push(option);
  }

  <span class="hljs-keyword">return</span> retOptions;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Manages a single repo</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Repo</span><span class="hljs-params">(aManager, aUsername, aReponame)</span> </span>{
  <span class="hljs-keyword">this</span>.manager = aManager;
  <span class="hljs-keyword">this</span>.user = aUsername;
  <span class="hljs-keyword">this</span>.repo = aReponame;
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use recursive requests to locate all user scripts in a repo</p></div></div><div class="code"><div class="wrapper">Repo.prototype.fetchUserScripts = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aCallback)</span> </span>{
  <span class="hljs-keyword">this</span>.getTree(<span class="hljs-string">'HEAD'</span>, <span class="hljs-string">''</span>, aCallback);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Looks for user script in the current directory
and initiates searches on subdirectories</p></div></div><div class="code"><div class="wrapper">Repo.prototype.parseTree = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aTree, aPath, aDone)</span> </span>{
  <span class="hljs-keyword">var</span> trees = [];
  <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> repos = <span class="hljs-keyword">this</span>.manager.repos;

  aTree.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(object)</span> </span>{
    <span class="hljs-keyword">if</span> (object.type === <span class="hljs-string">'tree'</span>) {
      trees.push({
        sha: object.sha, path: aPath + <span class="hljs-string">'/'</span>
          + <span class="hljs-built_in">encodeURI</span>(object.path)
      });
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object.path.substr(-<span class="hljs-number">8</span>) === <span class="hljs-string">'.user.js'</span>) {
      <span class="hljs-keyword">if</span> (!repos[that.repo]) { repos[that.repo] = nil(); }
      repos[that.repo][object.path] = aPath + <span class="hljs-string">'/'</span> + <span class="hljs-built_in">encodeURI</span>(object.path);
    }
  });

  async.each(trees, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aTree, aCallback)</span> </span>{
    that.getTree(aTree.sha, aTree.path, aCallback);
  }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    aDone();
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Gets information about a directory</p></div></div><div class="code"><div class="wrapper">Repo.prototype.getTree = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aSha, aPath, aCallback)</span> </span>{
  <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
  fetchJSON(<span class="hljs-string">'/repos/'</span> + <span class="hljs-built_in">encodeURI</span>(<span class="hljs-keyword">this</span>.user) + <span class="hljs-string">'/'</span> + <span class="hljs-built_in">encodeURI</span>(<span class="hljs-keyword">this</span>.repo)
    + <span class="hljs-string">'/git/trees/'</span> + aSha,
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aJson)</span> </span>{
      that.parseTree(aJson.tree, aPath, aCallback);
    }
  );
};

exports.getManager = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aUserId, aUser, aRepos)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RepoManager(aUserId, aUser, aRepos);
};</div></div></div></div></body></html>