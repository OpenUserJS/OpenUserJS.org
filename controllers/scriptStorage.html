<!DOCTYPE html><html lang="en"><head><title>controllers/scriptStorage</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="controllers/scriptStorage"><meta name="groc-project-path" content="controllers/scriptStorage.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">controllers/scriptStorage.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Define some pseudo module globals</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> isPro = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isPro;
<span class="hljs-keyword">var</span> isDev = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isDev;
<span class="hljs-keyword">var</span> isDbg = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isDbg;

<span class="hljs-keyword">var</span> AWS = <span class="hljs-built_in">require</span>(<span class="hljs-string">'aws-sdk'</span>);

<span class="hljs-keyword">var</span> Script = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/script'</span>).Script;
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/user'</span>).User;

<span class="hljs-keyword">var</span> cleanFilename = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/helpers'</span>).cleanFilename;
<span class="hljs-keyword">var</span> findDeadorAlive = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/remove'</span>).findDeadorAlive;
<span class="hljs-keyword">var</span> userRoles = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/userRoles.json'</span>);

<span class="hljs-keyword">var</span> bucketName = <span class="hljs-string">'OpenUserJS.org'</span>;

<span class="hljs-keyword">if</span> (isPro) {
  AWS.config.update({ region: <span class="hljs-string">'us-east-1'</span> });
} <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>You need to install (and ruby too): <a href="https://github.com/jubos/fake-s3">https://github.com/jubos/fake-s3</a>
Then run the fakes3.sh script or: fakes3 -r fakeS3 -p 10001</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> DEV_AWS_URL = process.env.DEV_AWS_URL || <span class="hljs-string">'localhost:10001'</span>;
  AWS.config.update({
    accessKeyId: <span class="hljs-string">'fakeId'</span>,
    secretAccessKey: <span class="hljs-string">'fakeKey'</span>,
    httpOptions: {
      proxy: DEV_AWS_URL,
      agent: <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>).globalAgent
    }
  });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInstallName</span><span class="hljs-params">(aReq)</span> </span>{
  <span class="hljs-keyword">return</span> aReq.params.username + <span class="hljs-string">'/'</span> + aReq.params.scriptname;
}
exports.getInstallName = getInstallName;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">caseInsensitive</span><span class="hljs-params">(aInstallName)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + aInstallName.replace(<span class="hljs-regexp">/([.?*+^$[\]\\(){}|-])/g</span>, <span class="hljs-string">"\\$1"</span>)
    + <span class="hljs-string">'$'</span>, <span class="hljs-string">'i'</span>);
}
exports.caseInsensitive = caseInsensitive;

exports.getSource = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aCallback)</span> </span>{
  <span class="hljs-keyword">var</span> s3 = <span class="hljs-keyword">new</span> AWS.S3();
  <span class="hljs-keyword">var</span> installName = getInstallName(aReq);

  Script.findOne({ installName: caseInsensitive(installName) },
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aScript)</span> </span>{
      <span class="hljs-keyword">var</span> s3Object = <span class="hljs-literal">null</span>;

      <span class="hljs-keyword">if</span> (!aScript) {
        <span class="hljs-keyword">return</span> aCallback(<span class="hljs-literal">null</span>);
      }

      s3Object = s3.getObject({ Bucket: bucketName, Key: installName }).createReadStream().
        on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">if</span> (isPro) {
            <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'S3 Key Not Found '</span> + installName);
          }

          <span class="hljs-keyword">return</span> aCallback(<span class="hljs-literal">null</span>);
        });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the script</p></div></div><div class="code"><div class="wrapper">      aCallback(aScript, s3Object);
    });
};

exports.sendScript = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> accept = aReq.headers.accept;

  <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> !== aReq.url.indexOf(<span class="hljs-string">'/libs/'</span>) &amp;&amp; accept === <span class="hljs-string">'text/x-userscript-meta'</span>) {
    <span class="hljs-keyword">return</span> exports.sendMeta(aReq, aRes, aNext);
  }

  exports.getSource(aReq, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aScript, aStream)</span> </span>{

    <span class="hljs-keyword">if</span> (!aScript) { <span class="hljs-keyword">return</span> aNext(); }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Send the script</p></div></div><div class="code"><div class="wrapper">    aRes.set(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/javascript; charset=UTF-8'</span>);
    aRes._no_minify = <span class="hljs-literal">true</span>;
    aStream.pipe(aRes);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Don&#39;t count installs on raw source route</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (aScript.isLib || aReq.params.type) { <span class="hljs-keyword">return</span>; }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update the install count</p></div></div><div class="code"><div class="wrapper">    ++aScript.installs;
    ++aScript.installsSinceUpdate;

    aScript.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aScript)</span> </span>{ });
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Send user script metadata block</p></div></div><div class="code"><div class="wrapper">exports.sendMeta = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> installName = getInstallName(aReq).replace(<span class="hljs-regexp">/\.meta\.js$/</span>, <span class="hljs-string">'.user.js'</span>);

  Script.findOne({ installName: caseInsensitive(installName) },
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aScript)</span> </span>{
      <span class="hljs-keyword">var</span> meta = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">var</span> data = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">var</span> prefix = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">var</span> key = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">var</span> whitespace = <span class="hljs-string">'\u0020\u0020\u0020\u0020'</span>;

      <span class="hljs-keyword">if</span> (!aScript) { <span class="hljs-keyword">return</span> aNext(); }

      aRes.set(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/javascript; charset=UTF-8'</span>);
      aRes._no_minify = <span class="hljs-literal">true</span>;
      meta = aScript.meta; <span class="hljs-comment">// NOTE: Watchpoint</span>

      aRes.write(<span class="hljs-string">'// ==UserScript==\n'</span>);
      <span class="hljs-built_in">Object</span>.keys(meta).reverse().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aName)</span> </span>{
        <span class="hljs-keyword">if</span> (meta[aName] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {
          meta[aName].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aValue)</span> </span>{
            aRes.write(<span class="hljs-string">'// @'</span> + aName + (aValue ? whitespace + aValue : <span class="hljs-string">''</span>) + <span class="hljs-string">'\n'</span>);
          });
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (meta[aName] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>) {
          prefix = aName;
          <span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> meta[aName]) {
            data = meta[prefix][key];
            <span class="hljs-keyword">if</span> (data <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {
              data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aValue)</span> </span>{
                aRes.write(<span class="hljs-string">'// @'</span> + prefix + <span class="hljs-string">':'</span> + key + (aValue ? whitespace + aValue : <span class="hljs-string">''</span>) + <span class="hljs-string">'\n'</span>);
              });
            }
            <span class="hljs-keyword">else</span> {
              aRes.write(<span class="hljs-string">'// @'</span> + prefix + <span class="hljs-string">':'</span> + key + (data ? whitespace + data : <span class="hljs-string">''</span>) + <span class="hljs-string">'\n'</span>);
            }
          }
        } <span class="hljs-keyword">else</span> {
          data = meta[aName];
          aRes.write(<span class="hljs-string">'// @'</span> + aName + (data ? whitespace + data : <span class="hljs-string">''</span>) + <span class="hljs-string">'\n'</span>);
        }
      });
      aRes.end(<span class="hljs-string">'// ==/UserScript==\n'</span>);
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Modified from Count Issues (<a href="http://userscripts.org/scripts/show/69307">http://userscripts.org/scripts/show/69307</a>)
By Marti Martz (<a href="http://userscripts.org/users/37004">http://userscripts.org/users/37004</a>)</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseMeta</span><span class="hljs-params">(aString, aNormalize)</span> </span>{
  <span class="hljs-keyword">var</span> rLine = <span class="hljs-regexp">/\/\/ @(\S+)(?:\s+(.*))?/</span>;
  <span class="hljs-keyword">var</span> headers = {};
  <span class="hljs-keyword">var</span> name = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> prefix = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> key = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> value = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> line = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> lineMatches = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> lines = {};
  <span class="hljs-keyword">var</span> uniques = {
    <span class="hljs-string">'description'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'icon'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'name'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'namespace'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'version'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'oujs:author'</span>: <span class="hljs-literal">true</span>
  };
  <span class="hljs-keyword">var</span> unique = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> one = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> matches = <span class="hljs-literal">null</span>;

  lines = aString.split(<span class="hljs-regexp">/[\r\n]+/</span>).filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aElement, aIndex, aArray)</span> </span>{
    <span class="hljs-keyword">return</span> (aElement.match(rLine));
  });

  <span class="hljs-keyword">for</span> (line <span class="hljs-keyword">in</span> lines) {
    <span class="hljs-keyword">var</span> header = <span class="hljs-literal">null</span>;

    lineMatches = lines[line].replace(<span class="hljs-regexp">/\s+$/</span>, <span class="hljs-string">''</span>).match(rLine);
    name = lineMatches[<span class="hljs-number">1</span>];
    value = lineMatches[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">if</span> (aNormalize) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Upmix from...</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">switch</span> (name) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'homepage'</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">'source'</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">'website'</span>:
          name = <span class="hljs-string">'homepageURL'</span>;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'defaulticon'</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-string">'iconURL'</span>:
          name = <span class="hljs-string">'icon'</span>;
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'licence'</span>:
          name = <span class="hljs-string">'license'</span>;
          <span class="hljs-keyword">break</span>;
      }
    }
    name = name.split(<span class="hljs-regexp">/:/</span>).reverse();
    key = name[<span class="hljs-number">0</span>];
    prefix = name[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">if</span> (key) {
      unique = {};
      <span class="hljs-keyword">if</span> (prefix) {
        <span class="hljs-keyword">if</span> (!headers[prefix]) {
          headers[prefix] = {};
        }
        header = headers[prefix];
        <span class="hljs-keyword">if</span> (aNormalize) {
          <span class="hljs-keyword">for</span> (one <span class="hljs-keyword">in</span> uniques) {
            matches = one.match(<span class="hljs-regexp">/(.*):(.*)$/</span>);
            <span class="hljs-keyword">if</span> (uniques[one] &amp;&amp; matches &amp;&amp; matches[<span class="hljs-number">1</span>] === prefix) {
              unique[matches[<span class="hljs-number">2</span>]] = <span class="hljs-literal">true</span>;
            }
          }
        }
      } <span class="hljs-keyword">else</span> {
        header = headers;
        <span class="hljs-keyword">if</span> (aNormalize) {
          <span class="hljs-keyword">for</span> (one <span class="hljs-keyword">in</span> uniques) {
            <span class="hljs-keyword">if</span> (uniques[one] &amp;&amp; !<span class="hljs-regexp">/:/</span>.test(one)) {
              unique[one] = <span class="hljs-literal">true</span>;
            }
          }
        }
      }
      <span class="hljs-keyword">if</span> (!header[key] || aNormalize &amp;&amp; unique[key]) {
        header[key] = value || <span class="hljs-string">''</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!aNormalize || header[key] !== (value || <span class="hljs-string">''</span>)
          &amp;&amp; !(header[key] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span> &amp;&amp; header[key].indexOf(value) &gt; -<span class="hljs-number">1</span>)) {
        <span class="hljs-keyword">if</span> (!(header[key] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>)) {
          header[key] = [header[key]];
        }
        header[key].push(value || <span class="hljs-string">''</span>);
      }
    }
  }
  <span class="hljs-keyword">return</span> headers;
}
exports.parseMeta = parseMeta;

exports.getMeta = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aChunks, aCallback)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We need to convert the array of buffers to a string to
parse the header. But strings are memory inefficient compared
to buffers so we only convert the least number of chunks to
get the user script header.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> str = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> header = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">for</span> (; i &lt; aChunks.length; ++i) {
    header = <span class="hljs-literal">null</span>;
    str += aChunks[i];
    header = <span class="hljs-regexp">/^(?:\uFEFF)?\/\/ ==UserScript==([\s\S]*?)^\/\/ ==\/UserScript==/m</span>.exec(str);

    <span class="hljs-keyword">if</span> (header &amp;&amp; header[<span class="hljs-number">1</span>]) { <span class="hljs-keyword">return</span> aCallback(parseMeta(header[<span class="hljs-number">1</span>], <span class="hljs-literal">true</span>)); }
  }

  aCallback(<span class="hljs-literal">null</span>);
};

exports.storeScript = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aUser, aMeta, aBuf, aCallback, aUpdate)</span> </span>{
  <span class="hljs-keyword">var</span> s3 = <span class="hljs-keyword">new</span> AWS.S3();
  <span class="hljs-keyword">var</span> scriptName = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> installName = aUser.name + <span class="hljs-string">'/'</span>;
  <span class="hljs-keyword">var</span> isLibrary = <span class="hljs-keyword">typeof</span> aMeta === <span class="hljs-string">'string'</span>;
  <span class="hljs-keyword">var</span> libraries = [];
  <span class="hljs-keyword">var</span> requires = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> collaborators = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> libraryRegex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^https?:\/\/'</span> +
    (isPro ?
      <span class="hljs-string">'openuserjs\.org'</span> : <span class="hljs-string">'localhost:8080'</span>) +
    <span class="hljs-string">'\/(?:libs\/src|src\/libs)\/(.+?\/.+?\.js)$'</span>, <span class="hljs-string">''</span>);

  <span class="hljs-keyword">if</span> (!aMeta) { <span class="hljs-keyword">return</span> aCallback(<span class="hljs-literal">null</span>); }

  <span class="hljs-keyword">if</span> (!isLibrary) {
    scriptName = cleanFilename(aMeta.name, <span class="hljs-string">''</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Can&#39;t install a script without a @name (maybe replace with random value)</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (!scriptName) { <span class="hljs-keyword">return</span> aCallback(<span class="hljs-literal">null</span>); }

    <span class="hljs-keyword">if</span> (!isLibrary &amp;&amp; aMeta.oujs &amp;&amp; aMeta.oujs.author
        &amp;&amp; aMeta.oujs.author != aUser.name &amp;&amp; aMeta.oujs.collaborator) {
      collaborators = aMeta.oujs.collaborator;
      <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">typeof</span> collaborators === <span class="hljs-string">'string'</span>
          &amp;&amp; collaborators === aUser.name)
          || (collaborators <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>
          &amp;&amp; collaborators.indexOf(aUser.name) &gt; -<span class="hljs-number">1</span>)) {
        installName = aMeta.oujs.author + <span class="hljs-string">'/'</span>;
      } <span class="hljs-keyword">else</span> {
        collaborators = <span class="hljs-literal">null</span>;
      }
    }

    installName += scriptName + <span class="hljs-string">'.user.js'</span>;

    <span class="hljs-keyword">if</span> (aMeta.require) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> aMeta.require === <span class="hljs-string">'string'</span>) {
        requires = [aMeta.require];
      } <span class="hljs-keyword">else</span> {
        requires = aMeta.require;
      }

      requires.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aRequire)</span> </span>{
        <span class="hljs-keyword">var</span> match = libraryRegex.exec(aRequire);
        <span class="hljs-keyword">if</span> (match &amp;&amp; match[<span class="hljs-number">1</span>]) { libraries.push(match[<span class="hljs-number">1</span>]); }
      });
    }
  } <span class="hljs-keyword">else</span> {
    scriptName = cleanFilename(aMeta.replace(<span class="hljs-regexp">/^\s+|\s+$/g</span>, <span class="hljs-string">''</span>), <span class="hljs-string">''</span>);
    <span class="hljs-keyword">if</span> (!scriptName) { <span class="hljs-keyword">return</span> aCallback(<span class="hljs-literal">null</span>); }

    installName += scriptName + <span class="hljs-string">'.js'</span>;
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Prevent a removed script from being reuploaded</p></div></div><div class="code"><div class="wrapper">  findDeadorAlive(Script, { installName: caseInsensitive(installName) }, <span class="hljs-literal">true</span>,
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aAlive, aScript, aRemoved)</span> </span>{
      <span class="hljs-keyword">if</span> (aRemoved || (!aScript &amp;&amp; (aUpdate || collaborators))) {
        <span class="hljs-keyword">return</span> aCallback(<span class="hljs-literal">null</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!aScript) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>New script</p></div></div><div class="code"><div class="wrapper">        aScript = <span class="hljs-keyword">new</span> Script({
          name: isLibrary ? aMeta : aMeta.name,
          author: aUser.name,
          installs: <span class="hljs-number">0</span>,
          rating: <span class="hljs-number">0</span>,
          about: <span class="hljs-string">''</span>,
          updated: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
          votes: <span class="hljs-number">0</span>,
          flags: <span class="hljs-number">0</span>,
          installName: installName,
          fork: <span class="hljs-literal">null</span>,
          meta: isLibrary ? { name: aMeta } : aMeta,
          isLib: isLibrary,
          uses: isLibrary ? <span class="hljs-literal">null</span> : libraries,
          _authorId: aUser._id
        });
      } <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Script already exists.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (!aScript.isLib) {
          <span class="hljs-keyword">if</span> (collaborators &amp;&amp; (aScript.meta.oujs &amp;&amp; aScript.meta.oujs.author != aMeta.oujs.author
              || (aScript.meta.oujs &amp;&amp; <span class="hljs-built_in">JSON</span>.stringify(aScript.meta.oujs.collaborator) !=
             <span class="hljs-built_in">JSON</span>.stringify(aMeta.oujs.collaborator)))) {
            <span class="hljs-keyword">return</span> aCallback(<span class="hljs-literal">null</span>);
          }
          aScript.meta = aMeta;
          aScript.uses = libraries;
        }
        aScript.updated = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        aScript.installsSinceUpdate = <span class="hljs-number">0</span>;
      }

      aScript.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aScript)</span> </span>{
        s3.putObject({ Bucket: bucketName, Key: installName, Body: aBuf },
          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aData)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Don&#39;t save a script if storing failed</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-keyword">if</span> (aErr) {
              <span class="hljs-built_in">console</span>.error(aUser.name, <span class="hljs-string">'-'</span>, installName);
              <span class="hljs-built_in">console</span>.error(<span class="hljs-built_in">JSON</span>.stringify(aErr));
              <span class="hljs-built_in">console</span>.error(<span class="hljs-built_in">JSON</span>.stringify(aScript.toObject()));
              <span class="hljs-keyword">return</span> aCallback(<span class="hljs-literal">null</span>);
            }

            <span class="hljs-keyword">if</span> (aUser.role === userRoles.length - <span class="hljs-number">1</span>) {
              <span class="hljs-keyword">var</span> userDoc = aUser;
              <span class="hljs-keyword">if</span> (!userDoc.save) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We&#39;re probably using req.session.user which may have gotten serialized.</p></div></div><div class="code"><div class="wrapper">                userDoc = <span class="hljs-keyword">new</span> User(userDoc);
              }
              --userDoc.role;
              userDoc.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aUser)</span> </span>{ aCallback(aScript); });
            } <span class="hljs-keyword">else</span> {
              aCallback(aScript);
            }
          });
      });
    });
};

exports.deleteScript = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aInstallName, aCallback)</span> </span>{
  Script.findOne({ installName: caseInsensitive(aInstallName) },
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aScript)</span> </span>{
      <span class="hljs-keyword">var</span> s3 = <span class="hljs-keyword">new</span> AWS.S3();
      s3.deleteObject({ Bucket : bucketName, Key : aScript.installName},
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr)</span> </span>{
          <span class="hljs-keyword">if</span> (!aErr) {
            aScript.remove(aCallback);
          } <span class="hljs-keyword">else</span> {
            aCallback(<span class="hljs-literal">null</span>);
          }
      });
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>GitHub calls this on a push if a webhook is setup
This controller makes sure we have the latest version of a script</p></div></div><div class="code"><div class="wrapper">exports.webhook = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes)</span> </span>{
  <span class="hljs-keyword">var</span> RepoManager = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/repoManager'</span>);
  <span class="hljs-keyword">var</span> payload = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> username = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> reponame = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> repos = {};
  <span class="hljs-keyword">var</span> repo = <span class="hljs-literal">null</span>;

  aRes.end(); <span class="hljs-comment">// Close connection</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Test for know GH webhook ips: <a href="https://api.github.com/meta">https://api.github.com/meta</a></p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (!aReq.body.payload ||
    !<span class="hljs-regexp">/192\.30\.25[2-5]\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])$/</span>
    .test(aReq.headers[<span class="hljs-string">'x-forwarded-for'</span>] || aReq.connection.remoteAddress)) {
    <span class="hljs-keyword">return</span>;
  }

  payload = <span class="hljs-built_in">JSON</span>.parse(aReq.body.payload);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Only accept commits to the master branch</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (!payload || payload.ref !== <span class="hljs-string">'refs/heads/master'</span>) { <span class="hljs-keyword">return</span>; }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Gather all the info for the RepoManager</p></div></div><div class="code"><div class="wrapper">  username = payload.repository.owner.name;
  reponame = payload.repository.name;

  repo = repos[reponame] = {};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Find the user that corresponds the repo owner</p></div></div><div class="code"><div class="wrapper">  User.findOne({ ghUsername: username }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aUser)</span> </span>{
    <span class="hljs-keyword">if</span> (!aUser) { <span class="hljs-keyword">return</span>; }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Gather the modified user scripts</p></div></div><div class="code"><div class="wrapper">    payload.commits.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aCommit)</span> </span>{
      aCommit.modified.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aFilename)</span> </span>{
        <span class="hljs-keyword">if</span> (aFilename.substr(-<span class="hljs-number">8</span>) === <span class="hljs-string">'.user.js'</span>) {
          repo[aFilename] = <span class="hljs-string">'/'</span> + <span class="hljs-built_in">encodeURI</span>(aFilename);
        }
      });
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update modified scripts</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> repoManager = RepoManager.getManager(<span class="hljs-literal">null</span>, aUser, repos);
    repoManager.loadScripts(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ }, <span class="hljs-literal">true</span>);
  });
};</div></div></div></div></body></html>