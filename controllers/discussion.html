<!DOCTYPE html><html lang="en"><head><title>controllers/discussion</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="controllers/discussion"><meta name="groc-project-path" content="controllers/discussion.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">controllers/discussion.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Define some pseudo module globals</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> isPro = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isPro;
<span class="hljs-keyword">var</span> isDev = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isDev;
<span class="hljs-keyword">var</span> isDbg = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isDbg;

<span class="hljs-keyword">var</span> async = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);

<span class="hljs-keyword">var</span> Comment = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/comment'</span>).Comment;
<span class="hljs-keyword">var</span> Discussion = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/discussion'</span>).Discussion;

<span class="hljs-keyword">var</span> modelParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/modelParser'</span>);
<span class="hljs-keyword">var</span> modelQuery = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/modelQuery'</span>);
<span class="hljs-keyword">var</span> cleanFilename = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/helpers'</span>).cleanFilename;
<span class="hljs-keyword">var</span> execQueryTask = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/tasks'</span>).execQueryTask;
<span class="hljs-keyword">var</span> statusCodePage = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/templateHelpers'</span>).statusCodePage;
<span class="hljs-keyword">var</span> pageMetadata = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/templateHelpers'</span>).pageMetadata;
<span class="hljs-keyword">var</span> orderDir = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/templateHelpers'</span>).orderDir;

<span class="hljs-keyword">var</span> categories = [
  {
    slug: <span class="hljs-string">'announcements'</span>,
    name: <span class="hljs-string">'Announcements'</span>,
    description: <span class="hljs-string">'UserScripts News (OpenUserJS, GreaseMonkey, etc)'</span>,
    roleReqToPostTopic: <span class="hljs-number">3</span> <span class="hljs-comment">// Moderator</span>
  },
  {
    slug: <span class="hljs-string">'garage'</span>,
    name: <span class="hljs-string">'The Garage'</span>,
    description: <span class="hljs-string">'Talk shop, and get help with user script development'</span>
  },
  {
    slug: <span class="hljs-string">'corner'</span>,
    name: <span class="hljs-string">'Beggar\'s Corner'</span>,
    description: <span class="hljs-string">'Propose ideas and request user scripts'</span>
  },
  {
    slug: <span class="hljs-string">'discuss'</span>,
    name: <span class="hljs-string">'General Discussion'</span>,
    description: <span class="hljs-string">'Off-topic discussion about anything related to user scripts or OpenUserJS.org'</span>
  },
  {
    slug: <span class="hljs-string">'issues'</span>,
    name: <span class="hljs-string">'Issues'</span>,
    description: <span class="hljs-string">'Discussions on scripts'</span>,
    virtual: <span class="hljs-literal">true</span>
  },
  {
    slug: <span class="hljs-string">'all'</span>,
    name: <span class="hljs-string">'All Discussions'</span>,
    description: <span class="hljs-string">'Overview of all discussions'</span>,
    virtual: <span class="hljs-literal">true</span>
  }
];
exports.categories = categories;

exports.categoryListPage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> authedUser = aReq.session.user;

  <span class="hljs-keyword">var</span> options = {};
  <span class="hljs-keyword">var</span> tasks = [];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Session</p></div></div><div class="code"><div class="wrapper">  authedUser = options.authedUser = modelParser.parseUser(authedUser);
  options.isMod = authedUser &amp;&amp; authedUser.isMod;
  options.isAdmin = authedUser &amp;&amp; authedUser.isAdmin;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Page metadata</p></div></div><div class="code"><div class="wrapper">  pageMetadata(options, <span class="hljs-string">'Discussions'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Order dir</p></div></div><div class="code"><div class="wrapper">  orderDir(aReq, options, <span class="hljs-string">'topic'</span>, <span class="hljs-string">'asc'</span>);
  orderDir(aReq, options, <span class="hljs-string">'comments'</span>, <span class="hljs-string">'desc'</span>);
  orderDir(aReq, options, <span class="hljs-string">'created'</span>, <span class="hljs-string">'desc'</span>);
  orderDir(aReq, options, <span class="hljs-string">'updated'</span>, <span class="hljs-string">'desc'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>categoryList</p></div></div><div class="code"><div class="wrapper">  options.categoryList = _.map(categories, modelParser.parseCategory);
  options.multipleCategories = <span class="hljs-literal">true</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> discussionListQuery = Discussion.find();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery: remove issues</p></div></div><div class="code"><div class="wrapper">  discussionListQuery.and({ issue: { $ne: <span class="hljs-literal">true</span> } });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery: Defaults</p></div></div><div class="code"><div class="wrapper">  modelQuery.applyDiscussionListQueryDefaults(discussionListQuery, options, aReq);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery: Pagination</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> pagination = options.pagination; <span class="hljs-comment">// is set in modelQuery.apply___ListQueryDefaults</span>

  <span class="hljs-comment">//--- Tasks</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pagination</p></div></div><div class="code"><div class="wrapper">  tasks.push(pagination.getCountTask(discussionListQuery));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery</p></div></div><div class="code"><div class="wrapper">  tasks.push(execQueryTask(discussionListQuery, options, <span class="hljs-string">'discussionList'</span>));

  <span class="hljs-comment">//---</span>
  async.parallel(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr)</span> </span>{
    <span class="hljs-keyword">if</span> (aErr) aNext();

    <span class="hljs-comment">//--- PreRender</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionList</p></div></div><div class="code"><div class="wrapper">    options.discussionList = _.map(options.discussionList, modelParser.parseDiscussion);
    _.map(options.discussionList, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aDiscussion)</span> </span>{
      <span class="hljs-keyword">var</span> category = _.findWhere(categories, { slug: aDiscussion.category });
      <span class="hljs-keyword">if</span> (!category) {
        category = modelParser.parseCategoryUnknown(aDiscussion.category);
      }
      aDiscussion.category = modelParser.parseCategory(category);
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pagination</p></div></div><div class="code"><div class="wrapper">    options.paginationRendered = pagination.renderDefault(aReq);

    <span class="hljs-comment">//---</span>
    aRes.render(<span class="hljs-string">'pages/categoryListPage'</span>, options);
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>List discussions for one of the three categories</p></div></div><div class="code"><div class="wrapper">exports.list = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> authedUser = aReq.session.user;

  <span class="hljs-keyword">var</span> categorySlug = aReq.params.category;

  <span class="hljs-keyword">var</span> category = _.findWhere(categories, { slug: categorySlug });
  <span class="hljs-keyword">if</span> (!category)
    <span class="hljs-keyword">return</span> aNext();

  <span class="hljs-keyword">var</span> options = {};
  <span class="hljs-keyword">var</span> tasks = [];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Session</p></div></div><div class="code"><div class="wrapper">  authedUser = options.authedUser = modelParser.parseUser(authedUser);
  options.isMod = authedUser &amp;&amp; authedUser.isMod;
  options.isAdmin = authedUser &amp;&amp; authedUser.isAdmin;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Category</p></div></div><div class="code"><div class="wrapper">  category = options.category = modelParser.parseCategory(category);
  options.canPostTopicToCategory = !category.virtual &amp;&amp; category.canUserPostTopic(authedUser);
  options.multipleCategories = category.virtual;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Page metadata</p></div></div><div class="code"><div class="wrapper">  pageMetadata(options, [category.name, <span class="hljs-string">'Discussions'</span>], category.description);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Order dir</p></div></div><div class="code"><div class="wrapper">  orderDir(aReq, options, <span class="hljs-string">'topic'</span>, <span class="hljs-string">'asc'</span>);
  orderDir(aReq, options, <span class="hljs-string">'comments'</span>, <span class="hljs-string">'desc'</span>);
  orderDir(aReq, options, <span class="hljs-string">'created'</span>, <span class="hljs-string">'desc'</span>);
  orderDir(aReq, options, <span class="hljs-string">'updated'</span>, <span class="hljs-string">'desc'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> discussionListQuery = Discussion.find();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery: category</p></div></div><div class="code"><div class="wrapper">  modelQuery.applyDiscussionCategoryFilter(discussionListQuery, options, category.slug);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery: Defaults</p></div></div><div class="code"><div class="wrapper">  modelQuery.applyDiscussionListQueryDefaults(discussionListQuery, options, aReq);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery: Pagination</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> pagination = options.pagination; <span class="hljs-comment">// is set in modelQuery.apply___ListQueryDefaults</span>

  <span class="hljs-comment">//--- Tasks</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pagination</p></div></div><div class="code"><div class="wrapper">  tasks.push(pagination.getCountTask(discussionListQuery));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionListQuery</p></div></div><div class="code"><div class="wrapper">  tasks.push(execQueryTask(discussionListQuery, options, <span class="hljs-string">'discussionList'</span>));

  <span class="hljs-comment">//---</span>
  async.parallel(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr)</span> </span>{
    <span class="hljs-keyword">if</span> (aErr) <span class="hljs-keyword">return</span> aNext();

    <span class="hljs-comment">//--- PreRender</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>discussionList</p></div></div><div class="code"><div class="wrapper">    options.discussionList = _.map(options.discussionList, modelParser.parseDiscussion);
    <span class="hljs-keyword">if</span> (category.virtual) {
      _.map(options.discussionList, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aDiscussion)</span> </span>{
        <span class="hljs-keyword">var</span> category = _.findWhere(categories, { slug: aDiscussion.category });
        <span class="hljs-keyword">if</span> (!category) {
          category = modelParser.parseCategoryUnknown(aDiscussion.category);
        }
        aDiscussion.category = modelParser.parseCategory(category);
      });
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pagination</p></div></div><div class="code"><div class="wrapper">    options.paginationRendered = pagination.renderDefault(aReq);

    <span class="hljs-comment">//---</span>
    aRes.render(<span class="hljs-string">'pages/discussionListPage'</span>, options);
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Locate a discussion and deal with topic url collisions</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findDiscussion</span><span class="hljs-params">(aCategory, aTopicUrl, aCallback)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>To prevent collisions we add an incrementing id to the topic url</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> topic = <span class="hljs-regexp">/(.+?)(?:_(\d+))?$/</span>.exec(aTopicUrl);
  <span class="hljs-keyword">var</span> query = { path: <span class="hljs-string">'/'</span> + aCategory + <span class="hljs-string">'/'</span> + topic[<span class="hljs-number">1</span>] };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We only need to look for the proper duplicate if there is one</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (topic[<span class="hljs-number">2</span>]) {
    query.duplicateId = <span class="hljs-built_in">Number</span>(topic[<span class="hljs-number">2</span>]);
  }

  Discussion.findOne(query, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aDiscussion)</span> </span>{
    <span class="hljs-keyword">if</span> (aErr || !aDiscussion) { <span class="hljs-keyword">return</span> aCallback(<span class="hljs-literal">null</span>); }
    aCallback(aDiscussion);
  });
}
exports.findDiscussion = findDiscussion;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>List comments in a discussion</p></div></div><div class="code"><div class="wrapper">exports.show = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> authedUser = aReq.session.user;

  <span class="hljs-keyword">var</span> categorySlug = aReq.params.category;
  <span class="hljs-keyword">var</span> topic = aReq.params.topic;

  <span class="hljs-keyword">var</span> category = _.findWhere(categories, { slug: categorySlug });
  <span class="hljs-keyword">if</span> (!category)
    <span class="hljs-keyword">return</span> aNext();

  findDiscussion(category.slug, topic, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aDiscussionData)</span> </span>{
    <span class="hljs-keyword">if</span> (!aDiscussionData) { <span class="hljs-keyword">return</span> aNext(); }

    <span class="hljs-keyword">var</span> options = {};
    <span class="hljs-keyword">var</span> tasks = [];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Session</p></div></div><div class="code"><div class="wrapper">    authedUser = options.authedUser = modelParser.parseUser(authedUser);
    options.isMod = authedUser &amp;&amp; authedUser.isMod;
    options.isAdmin = authedUser &amp;&amp; authedUser.isAdmin;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Category</p></div></div><div class="code"><div class="wrapper">    category = options.category = modelParser.parseCategory(category);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Discussion</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> discussion = options.discussion = modelParser.parseDiscussion(aDiscussionData);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Page metadata</p></div></div><div class="code"><div class="wrapper">    pageMetadata(options, [discussion.topic, <span class="hljs-string">'Discussions'</span>], discussion.topic);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>commentListQuery</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> commentListQuery = Comment.find();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>commentListQuery: discussion</p></div></div><div class="code"><div class="wrapper">    commentListQuery.find({ _discussionId: discussion._id });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>commentListQuery: Defaults</p></div></div><div class="code"><div class="wrapper">    modelQuery.applyCommentListQueryDefaults(commentListQuery, options, aReq);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>commentListQuery: Pagination</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> pagination = options.pagination; <span class="hljs-comment">// is set in modelQuery.apply___ListQueryDefaults</span>

    <span class="hljs-comment">//--- Tasks</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pagination</p></div></div><div class="code"><div class="wrapper">    tasks.push(pagination.getCountTask(commentListQuery));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>commentListQuery</p></div></div><div class="code"><div class="wrapper">    tasks.push(execQueryTask(commentListQuery, options, <span class="hljs-string">'commentList'</span>));

    <span class="hljs-comment">//---</span>
    async.parallel(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr)</span> </span>{
      <span class="hljs-keyword">if</span> (aErr) <span class="hljs-keyword">return</span> aNext();

      <span class="hljs-comment">//--- PreRender</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>commentList</p></div></div><div class="code"><div class="wrapper">      options.commentList = _.map(options.commentList, modelParser.parseComment);
      _.map(options.commentList, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aComment)</span> </span>{
        aComment.author = modelParser.parseUser(aComment._authorId);
      });
      _.map(options.commentList, modelParser.renderComment);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pagination</p></div></div><div class="code"><div class="wrapper">      options.paginationRendered = pagination.renderDefault(aReq);

      <span class="hljs-comment">//---</span>
      aRes.render(<span class="hljs-string">'pages/discussionPage'</span>, options);
    });
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>UI to create a new topic</p></div></div><div class="code"><div class="wrapper">exports.newTopic = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> authedUser = aReq.session.user;

  <span class="hljs-keyword">var</span> categorySlug = aReq.params.category;

  <span class="hljs-keyword">var</span> category = _.findWhere(categories, { slug: categorySlug });
  <span class="hljs-keyword">if</span> (!category)
    <span class="hljs-keyword">return</span> aNext();

  <span class="hljs-keyword">var</span> options = {};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Session</p></div></div><div class="code"><div class="wrapper">  authedUser = options.authedUser = modelParser.parseUser(authedUser);
  options.isMod = authedUser &amp;&amp; authedUser.isMod;
  options.isAdmin = authedUser &amp;&amp; authedUser.isAdmin;

  <span class="hljs-keyword">if</span> (!category.canUserPostTopic(authedUser)) {
    <span class="hljs-keyword">return</span> statusCodePage(aReq, aRes, aNext, {
      statusCode: <span class="hljs-number">403</span>,
      statusMessage: <span class="hljs-string">'You cannot post a topic to this category'</span>,
    });
  }

  options.category = category;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Page metadata</p></div></div><div class="code"><div class="wrapper">  pageMetadata(options, [<span class="hljs-string">'New Topic'</span>, <span class="hljs-string">'Discussions'</span>]);

  <span class="hljs-comment">//---</span>
  aRes.render(<span class="hljs-string">'pages/newDiscussionPage'</span>, options);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Does all the work of submitting a new comment and updating the discussion</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">postComment</span><span class="hljs-params">(aUser, aDiscussion, aContent, aCreator, aCallback)</span> </span>{
  <span class="hljs-keyword">var</span> created = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  <span class="hljs-keyword">var</span> comment = <span class="hljs-keyword">new</span> Comment({
    content: aContent,
    author: aUser.name,
    created: created,
    rating: <span class="hljs-number">0</span>,
    creator: aCreator,
    flags: <span class="hljs-number">0</span>,
    flagged: <span class="hljs-literal">false</span>,
    id: created.getTime().toString(<span class="hljs-number">16</span>),
    _discussionId: aDiscussion._id,
    _authorId: aUser._id
  });

  comment.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aComment)</span> </span>{
    ++aDiscussion.comments;
    aDiscussion.lastCommentor = aUser.name;
    aDiscussion.updated = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
    aDiscussion.save(aCallback);
  });
}
exports.postComment = postComment;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Does all the work of submitting a new topic and
resolving topic url collisions</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">postTopic</span><span class="hljs-params">(aUser, aCategory, aTopic, aContent, aIssue, aCallback)</span> </span>{
  <span class="hljs-keyword">var</span> urlTopic = cleanFilename(aTopic, <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/_\d+$/</span>, <span class="hljs-string">''</span>);
  <span class="hljs-keyword">var</span> path = <span class="hljs-string">'/'</span> + aCategory + <span class="hljs-string">'/'</span> + urlTopic;
  <span class="hljs-keyword">var</span> params = { sort: {} };
  params.sort.duplicateId = -<span class="hljs-number">1</span>;

  <span class="hljs-keyword">if</span> (!urlTopic) { aCallback(<span class="hljs-literal">null</span>); }

  Discussion.findOne({ path: path }, <span class="hljs-literal">null</span>, params, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aDiscussion)</span> </span>{
    <span class="hljs-keyword">var</span> newDiscussion = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> props = {
      topic: aTopic,
      category: aCategory,
      comments: <span class="hljs-number">0</span>,
      author: aUser.name,
      created: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
      lastCommentor: aUser.name,
      updated: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
      rating: <span class="hljs-number">0</span>,
      flagged: <span class="hljs-literal">false</span>,
      path: path,
      _authorId: aUser._id
    };

    <span class="hljs-keyword">if</span> (!aErr &amp;&amp; aDiscussion) {
      props.duplicateId = aDiscussion.duplicateId + <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
      props.duplicateId = <span class="hljs-number">0</span>;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Issues are just discussions with special properties</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (aIssue) {
      props.issue = <span class="hljs-literal">true</span>;
      props.open = <span class="hljs-literal">true</span>;
      props.labels = [];
    }

    newDiscussion = <span class="hljs-keyword">new</span> Discussion(props);

    newDiscussion.save(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aDiscussion)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now post the first comment</p></div></div><div class="code"><div class="wrapper">      postComment(aUser, aDiscussion, aContent, <span class="hljs-literal">true</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aDiscussion)</span> </span>{
        aCallback(aDiscussion);
      });
    });
  });
}
exports.postTopic = postTopic;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>post route to create a new topic</p></div></div><div class="code"><div class="wrapper">exports.createTopic = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> authedUser = aReq.session.user;

  <span class="hljs-keyword">var</span> categorySlug = aReq.params.category;
  <span class="hljs-keyword">var</span> topic = aReq.body[<span class="hljs-string">'discussion-topic'</span>];
  <span class="hljs-keyword">var</span> content = aReq.body[<span class="hljs-string">'comment-content'</span>];

  <span class="hljs-keyword">var</span> category = _.findWhere(categories, { slug: categorySlug });
  <span class="hljs-keyword">if</span> (!category)
    <span class="hljs-keyword">return</span> aNext();

  <span class="hljs-keyword">var</span> options = {};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Session</p></div></div><div class="code"><div class="wrapper">  authedUser = options.authedUser = modelParser.parseUser(authedUser);
  options.isMod = authedUser &amp;&amp; authedUser.isMod;
  options.isAdmin = authedUser &amp;&amp; authedUser.isAdmin;

  <span class="hljs-keyword">if</span> (!category.canUserPostTopic(authedUser)) {
    <span class="hljs-keyword">return</span> statusCodePage(aReq, aRes, aNext, {
      statusCode: <span class="hljs-number">403</span>,
      statusMessage: <span class="hljs-string">'You cannot post a topic to this category'</span>,
    });
  }

  postTopic(authedUser, category.slug, topic, content, <span class="hljs-literal">false</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aDiscussion)</span> </span>{
    <span class="hljs-keyword">if</span> (!aDiscussion) { <span class="hljs-keyword">return</span> exports.newTopic(aReq, aRes, aNext); }

    aRes.redirect(<span class="hljs-built_in">encodeURI</span>(aDiscussion.path
      + (aDiscussion.duplicateId ? <span class="hljs-string">'_'</span> + aDiscussion.duplicateId : <span class="hljs-string">''</span>)));
  });
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>post route to create a new comment on an existing discussion</p></div></div><div class="code"><div class="wrapper">exports.createComment = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> category = aReq.params.category;
  <span class="hljs-keyword">var</span> topic = aReq.params.topic;
  <span class="hljs-keyword">var</span> authedUser = aReq.session.user;
  <span class="hljs-keyword">var</span> content = aReq.body[<span class="hljs-string">'comment-content'</span>];

  <span class="hljs-keyword">if</span> (!authedUser) { <span class="hljs-keyword">return</span> aNext(); }

  findDiscussion(category, topic, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(discussion)</span> </span>{
    <span class="hljs-keyword">if</span> (!discussion) { <span class="hljs-keyword">return</span> aNext(); }

    postComment(authedUser, discussion, content, <span class="hljs-literal">false</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, discussion)</span> </span>{
      aRes.redirect(<span class="hljs-built_in">encodeURI</span>(discussion.path
        + (discussion.duplicateId ? <span class="hljs-string">'_'</span> + discussion.duplicateId : <span class="hljs-string">''</span>)));
    });
  });
};</div></div></div></div></body></html>