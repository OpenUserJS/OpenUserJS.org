<!DOCTYPE html><html lang="en"><head><title>controllers/auth</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="controllers/auth"><meta name="groc-project-path" content="controllers/auth.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">controllers/auth.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Define some pseudo module globals</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> isPro = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isPro;
<span class="hljs-keyword">var</span> isDev = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isDev;
<span class="hljs-keyword">var</span> isDbg = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/debug'</span>).isDbg;

<span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">var</span> allStrategies = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./strategies.json'</span>);
<span class="hljs-keyword">var</span> loadPassport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/passportLoader'</span>).loadPassport;
<span class="hljs-keyword">var</span> strategyInstances = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/passportLoader'</span>).strategyInstances;
<span class="hljs-keyword">var</span> Strategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/strategy.js'</span>).Strategy;
<span class="hljs-keyword">var</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/user'</span>).User;
<span class="hljs-keyword">var</span> verifyPassport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/passportVerify'</span>).verify;
<span class="hljs-keyword">var</span> cleanFilename = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/helpers'</span>).cleanFilename;
<span class="hljs-keyword">var</span> addSession = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../libs/modifySessions'</span>).add;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Unused but removing it breaks passport</p></div></div><div class="code"><div class="wrapper">passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aUser, aDone)</span> </span>{
  aDone(<span class="hljs-literal">null</span>, aUser._id);
});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setup all our auth strategies</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> openIdStrategies = {};
Strategy.find({}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aStrategies)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get OpenId strategies</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> allStrategies) {
    <span class="hljs-keyword">if</span> (!allStrategies[name].oauth) {
      openIdStrategies[name] = <span class="hljs-literal">true</span>;
      aStrategies.push({ <span class="hljs-string">'name'</span>: name, <span class="hljs-string">'openid'</span>: <span class="hljs-literal">true</span> });
    }
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Load the passport module for each strategy</p></div></div><div class="code"><div class="wrapper">  aStrategies.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aStrategy)</span> </span>{
    loadPassport(aStrategy);
  });
});

exports.auth = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> authedUser = aReq.session.user;
  <span class="hljs-keyword">var</span> strategy = aReq.body.auth || aReq.params.strategy;
  <span class="hljs-keyword">var</span> username = aReq.body.username || aReq.session.username;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">auth</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> authenticate = passport.authenticate(strategy);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just in case some dumbass tries a bad /auth/* url</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (!strategyInstances[strategy]) { <span class="hljs-keyword">return</span> aNext(); }

    authenticate(aReq, aRes);
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Allow a logged in user to add a new strategy</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (strategy &amp;&amp; authedUser) {
    aReq.session.username = authedUser.name;
    <span class="hljs-keyword">return</span> auth();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (authedUser) {
    <span class="hljs-keyword">return</span> aNext();
  }

  <span class="hljs-keyword">if</span> (!username) { <span class="hljs-keyword">return</span> aRes.redirect(<span class="hljs-string">'/register?noname'</span>); }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clean the username of leading and trailing whitespace,
and other stuff that is unsafe in a url</p></div></div><div class="code"><div class="wrapper">  username = cleanFilename(username.replace(<span class="hljs-regexp">/^\s+|\s+$/g</span>, <span class="hljs-string">''</span>));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The username could be empty after the replacements</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (!username) { <span class="hljs-keyword">return</span> aRes.redirect(<span class="hljs-string">'/register?noname'</span>); }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Store the username in the session so we still have it when they
get back from authentication</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (!aReq.session.username) {
    aReq.session.username = username;
  }

  User.findOne({ name: { $regex: <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + username + <span class="hljs-string">'$'</span>, <span class="hljs-string">'i'</span>) } },
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aUser)</span> </span>{
      <span class="hljs-keyword">var</span> strategies = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">var</span> strat = <span class="hljs-literal">null</span>;

      <span class="hljs-keyword">if</span> (aUser) {
        strategies = aUser.strategies;
        strat = strategies.pop();

        <span class="hljs-keyword">if</span> (aReq.session.newstrategy) { <span class="hljs-comment">// authenticate with a new strategy</span>
          <span class="hljs-keyword">delete</span> aReq.session.newstrategy;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!strategy) { <span class="hljs-comment">// use an existing strategy</span>
          strategy = strat;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strategies.indexOf(strategy) === -<span class="hljs-number">1</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>add a new strategy but first authenticate with existing strategy</p></div></div><div class="code"><div class="wrapper">          aReq.session.newstrategy = strategy;
          strategy = strat;
        } <span class="hljs-comment">// else use the strategy that was given in the POST</span>
      }

      <span class="hljs-keyword">if</span> (!strategy) {
        <span class="hljs-keyword">return</span> aRes.redirect(<span class="hljs-string">'/register'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> auth();
      }
    });
};

exports.callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">var</span> strategy = aReq.params.strategy;
  <span class="hljs-keyword">var</span> username = aReq.session.username;
  <span class="hljs-keyword">var</span> newstrategy = aReq.session.newstrategy;
  <span class="hljs-keyword">var</span> strategyInstance = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> doneUrl = aReq.session.user ? <span class="hljs-string">'/user/preferences'</span> : <span class="hljs-string">'/'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The callback was called improperly</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (!strategy || !username) { <span class="hljs-keyword">return</span> aNext(); }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the passport strategy instance so we can alter the _verfiy method</p></div></div><div class="code"><div class="wrapper">  strategyInstance = strategyInstances[strategy];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Hijak the private verify method so we can fuck shit up freely
We use this library for things it was never intended to do</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (openIdStrategies[strategy]) {
    strategyInstance._verify = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aId, aDone)</span> </span>{
      verifyPassport(aId, strategy, username, aReq.session.user, aDone);
    };
  } <span class="hljs-keyword">else</span> {
    strategyInstance._verify =
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aToken, aRefreshOrSecretToken, aProfile, aDone)</span> </span>{
        aReq.session.profile = aProfile;
        verifyPassport(aProfile.id, strategy, username, aReq.session.user, aDone);
      };
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This callback will happen after the verify routine</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> authenticate = passport.authenticate(strategy, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr, aUser, aInfo)</span> </span>{
    <span class="hljs-keyword">if</span> (aErr) { <span class="hljs-keyword">return</span> aNext(aErr); }
    <span class="hljs-keyword">if</span> (!aUser) {
      <span class="hljs-keyword">return</span> aRes.redirect(doneUrl + (doneUrl === <span class="hljs-string">'/'</span> ? <span class="hljs-string">'register'</span> : <span class="hljs-string">''</span>)
        + <span class="hljs-string">'?authfail'</span>);
    }

    aReq.logIn(aUser, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aErr)</span> </span>{
      <span class="hljs-keyword">if</span> (aErr) { <span class="hljs-keyword">return</span> aNext(aErr); }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Store the user info in the session</p></div></div><div class="code"><div class="wrapper">      aReq.session.user = aUser;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save the session id on the user model</p></div></div><div class="code"><div class="wrapper">      aUser.sessionId = aReq.sessionID;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save GitHub username.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (aReq.session.profile &amp;&amp; aReq.session.profile.provider === <span class="hljs-string">'github'</span>) {
        aUser.ghUsername = aReq.session.profile.username;
      }

      addSession(aReq, aUser, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (newstrategy) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Allow a user to link to another acount</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">return</span> aRes.redirect(<span class="hljs-string">'/auth/'</span> + newstrategy);
        } <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Delete the username that was temporarily stored</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">delete</span> aReq.session.username;
          doneUrl = aReq.session.redirectTo || doneUrl;
          <span class="hljs-keyword">delete</span> aReq.session.redirectTo;
          <span class="hljs-keyword">return</span> aRes.redirect(doneUrl);
        }
      });
    });
  });

  authenticate(aReq, aRes, aNext);
};

exports.validateUser = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateUser</span><span class="hljs-params">(aReq, aRes, aNext)</span> </span>{
  <span class="hljs-keyword">if</span> (!aReq.session.user) {
    aReq.session.redirectTo = aReq.path;
    <span class="hljs-keyword">return</span> aRes.redirect(<span class="hljs-string">'/login'</span>);
  }
  <span class="hljs-keyword">return</span> aNext();
};</div></div></div></div></body></html>